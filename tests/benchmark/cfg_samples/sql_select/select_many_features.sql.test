-- complex SQL statement generated by ChatGPT
SELECT
    T1."Employee Name",
    T1.Department,
    T2.TotalSales,
    AVG(T3.Salary) OVER (PARTITION BY T1.Department ORDER BY T1."Employee Name" ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS AvgDeptSalary,
    SUM(CASE WHEN T4.Month = 'January' THEN T4.Sales ELSE 0 END) AS JanuarySales,
    RANK() OVER (ORDER BY T2.TotalSales DESC) AS SalesRank,
    DENSE_RANK() OVER (PARTITION BY T1.Department ORDER BY T1."Employee Name") AS DeptRank,
    COALESCE(T5.Bonus, 0) AS Bonus
FROM
    Employees T1
INNER JOIN
    (SELECT EmployeeID, SUM(Sales) AS TotalSales FROM Sales GROUP BY EmployeeID) T2 ON T1.EmployeeID = T2.EmployeeID
LEFT JOIN --LEFT JOIN  -- TODO: Fix LALR so LEFT JOIN is legal
    Salaries T3 ON T1.EmployeeID = T3.EmployeeID AND T3.Year = 2023
LEFT OUTER JOIN
    Sales T4 ON T1.EmployeeID = T4.EmployeeID
LEFT OUTER JOIN
    (SELECT EmployeeID, SUM(Bonus) AS Bonus FROM Bonuses WHERE Year = 2023 GROUP BY EmployeeID) T5 ON T1.EmployeeID = T5.EmployeeID
WHERE
    T1.Department IS NOT NULL AND T2.TotalSales > 10000
GROUP BY
    T1."Employee Name", T1.Department, T2.TotalSales, T5.Bonus
 HAVING
    AVG(T3.Salary) > 50000
ORDER BY
    SalesRank, T1.Department, T1."Employee Name"
LIMIT 10
